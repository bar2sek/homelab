# Option 1: Talos Kubernetes

## Setting up talos k8s on proxmox from talos.dev
1. Create an external load balancer.
    1. Install Traefik?
1. Create 1 control plane VM and 1 worker VM on each of the 3 nodes, give at least 2 cores, VM network, all else default.
1. Turn on each VM and get IP of only one of the cp nodes created.
1. `export CONTROL_PLANE_IP=1.2.3.4`
1. `talosctl gen config talos-pxmx-cluster https://$CONTROL_PLANE_IP:6443 --output-dir _out`
1. `talosctl apply-config --insecure --nodes $CONTROL_PLANE_IP --file _out/controlplane.yaml`
1. `export WORKER_IP=1.2.3.4`
1. `talosctl apply-config --insecure --nodes $WORKER_IP --file _out/worker.yaml`
1. ```bash
    export TALOSCONFIG="_out/talosconfig"
    talosctl config endpoint $CONTROL_PLANE_IP
    talosctl config node $CONTROL_PLANE_IP
1. ```bash
    talosctl --talosconfig _out/talosconfig config endpoint $CONTROL_PLANE_IP
    talosctl --talosconfig _out/talosconfig config node $CONTROL_PLANE_IP
1. `talosctl --talosconfig _out/talosconfig bootstrap`
1. `talosctl --talosconfig _out/talosconfig kubeconfig`
1. `export KUBECONFIG=kubeconfig`
1. `kubectl get nodes`

One only needs the IP of one cp node to bootstrap?


## DevOps Toolkit Method

He creates workers using a Cloud-init Digital Ocean `doctl --user-data-file` method that inputs the worker.yml file generated by talos at creation time. Same with Controlplane nodes.

Can I use [qm](https://pve.proxmox.com/pve-docs/chapter-qm.html#qm_cloud_init) cli and cloud-init to do the same thing?

`qm create --cicustom` [meta=<volume>] [,network=<volume>] [,user=<volume>] [,vendor=<volume>]
cloud-init: Specify custom files to replace the automatically generated ones at start.


1. Load Balancer?
    ```bash
    talosctl gen config \
    talos-demo https://$LB_IP:443 \
    --kubernetes-version 1.23.0
1. Create all nodes in Proxmox
1. get one cp node IP: `export $CP_IP_1`
1. ```bash
    talosctl --talosconfig talosconfig \
    config endpoint $CP_IP_1
1. ```bash
    talosctl --talosconfig talosconfig \
    config node $CP_IP_1
1. ```bash
    talosctl --talosconfig talosconfig \
    bootstrap
1. ```bash
    talosctl --talosconfig talosconfig kubeconfig kubeconfig.yaml`
1. ```bash
    export KUBECONFIG=kubeconfig`
1. ```bash
    kubectl get nodes

## Resources
[talos on proxmox setup](https://www.talos.dev/v1.0/talos-guides/install/virtualized-platforms/proxmox/)
[DevOps Toolkit](https://www.youtube.com/watch?v=iEFb2Zg4xUg&t=442s)

# Option 2: k3s Kubernetes

## Overview
1. Can use [Rook](https://rook.io) to use current Ceph cluster?
1. Spin up cloud-init Ubuntu nodes and install [k3s](https://k3s.io) on them with [Ansible](https://docs.ansible.com/?extIdCarryOver=true&sc_cid=701f2000001OH7YAAW)
1. [kube-vip](https://kube-vip.io) external load balancer
1. [MetalLB](https://metallb.universe.tf) service load balancer

## Proxmox Quick [Instructions](https://www.youtube.com/watch?v=CbkEWcUZ7zM&t=284s):
1. Create 5 VMs in Pxmx cluster with Ubuntu [cloud-init](https://www.youtube.com/watch?v=shiIi38cJe4)
    * k3s-server01:`ssh -i .ssh/id_rsa ryan@10.10.50.244`
1. Config [Ansible](https://www.youtube.com/watch?v=w9eCU4bGgjQ) Playbook
1. 

## Azure Arc integration with on-prem k3s cluster
1. Use Terraform examples [here](https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/rancher_k3s/azure_terraform/)